共有メモリをマイコンから扱うコードは、ページ下部にあります。  
Arduino用のコードですが、移植しやすいように心がけたつもりなので、他のマイコンでも使えると思います。  
これをArduinoのライブラリとしてまとめたのはこちらのページに有ります。  
  
公式のサンプルと異なり、SPI通信用のライブラリ以外に依存していません。  
  
＊共有メモリとは  
そもそも、共有メモリとは何なのか、説明しておきます。  
一応、FlashAir-Developersにも解説があるのですが、念のため。  
  
共有メモリは、FlashAirのiSDIO空間にある512Byteの領域で、アドレスで言うと01000h-01FFFhの先頭512Byte、  
規格上はReserved for Vendorとされている場所に割り当てられた領域です。  
iSDIOのコマンドCMD48, CMD49で読み出し、書き込みができます。  
※W-04はCMD17,CMD24です  
  
共有メモリというからには、どこかと共有しているわけです。  
1つは、外部のマイコンですが、他は何でしょう？  
  
W-02では、HTTPサーバーと共有していました。  
command.cgiのリファレンスページに、記載があります。  
これにより、マイコンと、ブラウザ上のjavascriptで、Ajaxを用いた通信が出来ました。  
  
W-03では、さらにLuaスクリプトが動くようになり、スクリプト上にて、fa.sharedmemory関数によってアクセスできるようになりました。  
これによって、HTTPサーバーとLuaスクリプト間の連携や、Luaスクリプト同士の処理の引き継ぎ、  
Luaスクリプトと外部マイコンの通信など、様々な用途に使えるようになりました。  
  
マイコンからも、HTTPサーバーからも、Luaスクリプトからも、1Byte単位で扱うことが出来ます。  
  
  
  
Luaスクリプトから外部マイコンと通信する手段はいくつかあります。  
1. fa.pioを使った、ソフトパラレル通信。ソフトSPI、ソフトI2C等、ピン操作による通信  
　→Luaインタプリタの速度もあり、低速。また通信中は他の処理ができない。  
2. fa.spiを使ったSPI通信  
　→1Byte辺りの速度は高速だが、親がFlashAir側であり、また通信中は他の処理ができない。  
3. ファイルの受け渡し  
　→通信はSDカードコントローラがやるので、両者好きなタイミングでやりとりできる。かなり大規模なデータのやり取りも可能。しかし、あまり頻繁だとフラッシュの寿命が縮む。  
4. iSDIOの共有メモリを用いた通信  
　→マイコン側が親であり、通信はSDカードコントローラがやるので2.5ms程度で512Byteの送信ができる。メモリ上なのでフラッシュの心配もない。  
  
  
また、共有メモリのメリットはもう一つあり、それはメモリの少ないマイコンでも扱えるということです。  
通常のSDカード同様のFATファイルシステムに書き込むためには、最低でもFATを扱うために512Byte、さらにファイルの領域分のメモリが必要となりますが、  
共有メモリは、単なるバイト列ですので、SDカードにアクセスするための引数の計算に使う8～10Byte程度があれば書き込み・読み出しができます。  
  
また、iSDIOのアクセスは512Byte単位ですが、アクセス時には長さの指定ができ、そのため、必要なバイト数の操作を終えたら、あとは読み飛ばし・書き飛ばしをすれば済みます。  
ただ、その読み飛ばし・書き飛ばしにも相応の時間がかかるため、512Byte一気に扱えない場合は、アクセス回数分の時間がかかります。  
(1回に付き概ね2.5ms@4MHzです。SPIのクロックにもよります。)  
  
特に、1Byte単位でアクセスした場合は、ひどく時間的に無駄となります。  
なので、SharedMemWriteSimple, SharedMemReadSimpleというのはかなり無駄な処理なのですが、  
それでも1Byte単位で扱いたい場合というのがありそうな気がしたので、用意しておきました。  
  
※command.cgiは、共有メモリのバイナリは読み出せても、バイナリを書き込むことは出来なかった気がします。(URIの制限で)  
　ので、512Byteをビット単位でフル活用は出来ないと思うので、ご注意ください。Luaスクリプトの方は問題なかった気がします。  
  
＊コードの説明  
やっていることは、本当にただのSDコマンドの発行です。  
SharedMemInitでは、74クロックの起動クロック、CMD0の発行(リセット)、CMD8(問い合わせ&設定)、ACMD41(SDHCの初期化)をしています。  
CMD8が必要だったり、ACMD41にSDHC/XC用のビットを立てる必要があったりと、色々ハマりポイントが有って苦労しましたが。  
今回のコードは、FlashAir専用(といっても共有メモリを実装しているのはFlashAirしかない)なので、種々の判定や場合分けは無視してハードコーディングしています。  
  
SharedMemWriteはCMD49, SharedMemReadはCMD48の発行をしています。  
※W-04はSharedMemWriteはCMD24, SharedMemReadはCMD17  
本来は、ReadExt, WriteExtなどと分けて実装するようなのですが、無視して、共有メモリ専用にしています。  
それによって、大分シンプルに作ることが出来ました。  
  
というのも、私がこれを使いたいのはArduinoではなく、いわゆるRAMが少なすぎてSDカードの扱えないPIC16Fシリーズや12Fシリーズなどで  
使うことを考えていたので、汎用性を上げるより、ROMを節約したかったのです。  
  
＊コード  
繰り返しになりますが、このコードは、Arduino用のライブラリとして別ページにて配布しています。  
参考のために、ページ上にも掲載しています。  
  
※W-04は書き換えが必要です！SharedMemWriteはCMD49→CMD24, SharedMemReadはCMD48→CMD17にしてください！  
